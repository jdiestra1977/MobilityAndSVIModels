---
title: "Models for Mobility and SVI"
output: html_document
date: "2022-08-23"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
cuberoot <- function(x)sign(x)*abs(x)^(1/3)

```

## R Markdown

Number of visits made between zip codes in the year 2020, along with the re-scaled and standardized versions.

```{r Visits,fig.width=7}
load("totalVisitsByZipVsTime.RData")
totalVisitsByZipVsTime %>% mutate(TotalVisits=InterVisitsOut+InterVisitsIn) %>%
  select(Date,Zip,TotalVisits) %>%
  merge(totalVisitsByZipVsTime %>% mutate(TotalVisits=InterVisitsOut+InterVisitsIn) %>%
        ungroup() %>% select(Zip,TotalVisits) %>% group_by(Zip) %>%
          summarise_each(funs(mean,sd)),by="Zip") %>%
  mutate(TotalVisitsScaled=cuberoot(TotalVisits),TotalVisitsStand=(TotalVisits-mean)/sd) %>%
  select(Zip,Date,TotalVisits,TotalVisitsScaled,TotalVisitsStand) %>% arrange(Zip,Date) %>%
  pivot_longer(cols = contains("Total"),names_to = "Source",values_to = "Visits") %>%
  ggplot(aes(x=as.Date(Date),y=Visits,group=Zip))+
  theme_bw()+
  geom_line(size=1,alpha=07,color="gray") +
  ylab("Total visits between zip codes") + xlab("")+
  facet_wrap(~Source,ncol=1,scales = "free") +
  theme(text=element_text(size=20))
```

variables in the file are:
```{r pressure, echo=FALSE}
names(totalVisitsByZipVsTime)
```

Dates, are in days; Zip, are 45 zip codes in the metropolitan area of the city of Austin; IntraVisits, InterVisitsOut and InterVisitsIn are the visits made within, from and to the given zip codes in 2020, respectively; and baselineIntra, baselineOut and baselineIn are the within, from and to a zip code in the baseline year (2019), respectively.

Then, the mobility ratio for zip code $i$ at a day $t$ in year 2020 is calculated as $MR_i^t=\frac{\sum_i (V^t_{ij}+V^t_{ji})}{\sum_i (V^b_{ij}+V^b_{ji})}$, where $V_{ij}$ and $V_{ji}$ are the visits made from/to zip code $i$ to/from all other  zip codes $j$, respectively; and $b$ is the corresponding day in year 2019.

With these data, we calculate the mobility ratio and the re-scaled (with the cubic root) and  the standardized versions of the mobility ratio

```{r pressure, echo=FALSE,fig.width=7}
totalVisitsByZipVsTime %>% 
  mutate(MobRatio=(InterVisitsOut+InterVisitsIn)/(baselineOut+baselineIn)) %>%
  select(Date,Zip,MobRatio) %>%
  merge(totalVisitsByZipVsTime %>%
          mutate(MobRatio=(InterVisitsOut+InterVisitsIn)/(baselineOut+baselineIn)) %>%
          ungroup() %>% select(Zip,MobRatio) %>% group_by(Zip) %>%
          summarise_each(funs(mean,sd)),by="Zip") %>% 
  mutate(MobRatioStand=(MobRatio-mean)/sd) %>% mutate(MobRatioScaled=cuberoot(MobRatio)) %>%
  arrange(Zip,Date) %>% select(Zip,Date,MobRatio,MobRatioStand,MobRatioScaled) %>%
  pivot_longer(cols = c(MobRatio,MobRatioStand,MobRatioScaled),names_to = "Source",values_to = "MobRatios") %>%
  filter(Date>=as.Date("2020-01-01"),Date<as.Date("2020-06-01")) %>%
  ggplot(aes(x=as.Date(Date),y=MobRatios,group=Zip))+ theme_bw()+
  geom_line(size=1,color="gray",alpha=0.7) +
  facet_wrap(~Source,ncol=1,scales = "free") +
  ylab("Mobility ratios") + xlab("") +
  theme(text=element_text(size=20))
```


```{r pressure, echo=FALSE,fig.width=7}
load("distancesActualWithStand.RData")
distancesActualWithStand %>%
  pivot_longer(cols = c("WM_2020","StandDistActual","ScaledDistActual"),names_to = "Source",values_to = "Distance") %>%
  mutate(Source= Source %>% fct_relevel(c("WM_2020","ScaledDistActual","StandDistActual"))) %>%
  ggplot(aes(x=as.Date(Date),y=Distance,group=Zip))+
  geom_line(size=1,color="gray",alpha=0.7) +
  facet_wrap(~Source,ncol=1,scales = "free") +
  ylab("Weighted mean distance") + xlab("") +
  theme(text=element_text(size=20))

```

```{r,fig.width=7}
load("distanceRatioWithStand.RData")
distanceRatioWithStand %>% select(-WM_2020) %>%
  pivot_longer(cols = c("DistRatio","ScaledDist","StandDist"),names_to = "Source",values_to = "DistRatio") %>%
  filter(Date>=as.Date("2020-01-01"),Date<as.Date("2020-06-01")) %>%
 ggplot(aes(x=as.Date(Date),y=DistRatio,group=Zip))+
  geom_line(size=1,color="gray",alpha=0.7) +
  facet_wrap(~Source,ncol=1,scales = "free") +
  ylab("Weighted mean distance") + xlab("") +
  theme(text=element_text(size=20))

```

Additonally, this is the file with SVI and hospitalizations and other variables for the zip codes in Austin. To select the same as above, filter for the Travis County

```{r}
load("forMapsWithSVI.RData")
forMapsWithSVI %>% head()

```

#Idea for the model

Basically, what we want to predict is mobility in each zip code using information of SVI and other factors.

So, for a given zip code $i$, given the time of the year (not necesarily in covid19 times), can we make a statistical model to predict its mobility (or mobility ratio, or else)?
The response variable: mobility
The explanatori variables: SVI and other information contained in it: mean income, age distribution, other?
